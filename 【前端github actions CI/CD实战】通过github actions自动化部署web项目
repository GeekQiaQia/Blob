
![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/15036e0e50004a338899fc836e859a90~tplv-k3u1fbpfcp-watermark.image?)

# èƒŒæ™¯
ç®€å•ã€å¿«æ·ã€å®‰å…¨ã€æ–¹ä¾¿æ°¸è¿œç‹¬ç«‹å¼€å‘è€…çš„ç¬¬ä¸€é€‰æ‹©ã€‚ç”±äºæˆ‘ä»¬çš„å›¢é˜Ÿé¡¹ç›®åœ¨Githubå­˜å‚¨å’Œç®¡ç†ï¼Œå¯¹æ¯”ä¸**jenkins** **Travis CI**å’Œ**CircleCI**ç¬¬ä¸‰æ–¹å¹³å°ï¼Œæœ€ç»ˆé€‰æ‹©äº†ç”¨GitHub Actionsè½»é‡çº§çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æ¥å®ç°CI/CDã€‚
## GitHub Actions

 [github actions å®˜æ–¹ä¼ é€é—¨](https://docs.github.com/cn/actions/learn-github-actions/understanding-github-actions)
 
 **GitHub** æä¾›é¢„é…ç½®çš„å·¥ä½œæµç¨‹æ¨¡æ¿ï¼Œæ‚¨å¯ä»¥è‡ªå®šä¹‰ä»¥åˆ›å»ºè‡ªå·±çš„æŒç»­é›†æˆå·¥ä½œæµç¨‹ã€‚ GitHub åˆ†æä»£ç å¹¶æ˜¾ç¤ºå¯èƒ½é€‚ç”¨äºæ‚¨çš„ä»“åº“çš„ CI æ¨¡æ¿ã€‚æ‚¨ä¹Ÿå¯ä»¥ä»`marketplace`æŸ¥è¯¢é€‰æ‹©æ‚¨éœ€è¦çš„Actions CI;
 
 ä¸¾ä¾‹ï¼šæŸ¥è¯¢æ–‡ä»¶copy ä¸`scp`ç›¸å…³çš„actions,å¦‚ä¸‹æ‰€ç¤ºï¼š 
 
 [marketplace å®˜æ–¹ä¼ é€é—¨](https://github.com/marketplace?type=actions&query=scp+)
 
![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9f6cd9504c9483ca7d87625d0a95efc~tplv-k3u1fbpfcp-watermark.image?)

### workflow åŸºæœ¬æ¦‚å¿µ

#### workflow

å·¥ä½œæµç¨‹ï¼ŒæŒç»­é›†æˆä¸€æ¬¡è¿è¡Œçš„è¿‡ç¨‹ï¼Œå°±å¯ä»¥ç§°ä¹‹ä¸ºä¸€ä¸ªworkflow

##### `name`

    >å·¥ä½œæµç¨‹çš„åç§°ï¼ˆå¯ç©ºï¼‰ï¼Œå¦‚æœè®¾ç½®ï¼Œåˆ™ä¼šåœ¨GitHubçš„æ“ä½œé¡µé¢ä¸Šæ˜¾ç¤ºå·¥ä½œæµçš„åç§°

##### `on`

   > è§¦å‘å·¥ä½œæµçš„äº‹ä»¶åç§°ã€‚è­¬å¦‚å‘èµ·çš„push/pull_requestç­‰æ“ä½œè§¦å‘ã€‚å¯ä»¥åªç›‘å¬æŸä¸€ä¸ªäº‹ä»¶`string`ï¼Œæˆ–è€…å¤šä¸ªäº‹ä»¶ã€‚[å¯ä»¥è§¦å‘å·¥ä½œæµç¨‹çš„äº‹ä»¶](https://docs.github.com/cn/articles/events-that-trigger-workflows)

    ```
    # ç¤ºä¾‹ï¼šä½¿ç”¨å•ä¸€äº‹ä»¶ç›‘å¬pushæ“ä½œï¼Œä»»æ„pushéƒ½ä¼šè¢«è§¦å‘
    on: push
    â€‹
    #  ç¤ºä¾‹ï¼šä½¿ç”¨äº‹ä»¶åˆ—è¡¨ ç›‘å¬ä»»æ„çš„pushå’Œpull_request
    on: [push, pull_request]
    ```

    ä»¥ä¸Šä¿©ä¸ªç¤ºä¾‹æˆ‘ä»¬åœ¨ä»“åº“çš„ä»»æ„åˆ†æ”¯æ‰§è¡Œpushæˆ–è€…pull_requestéƒ½ä¼šè§¦å‘ç›¸åº”çš„actions æµç¨‹ï¼Œå®é™…å¼€å‘ä¸­ä¼šæ–°å»ºå¾ˆå¤šåˆ†æ”¯ï¼Œè€Œä¸”ä¸ºäº†æ›´å¥½çš„ç®¡ç†æµç¨‹ï¼Œtest/dev/uat/releaseç­‰ç­‰ä¸€ç³»åˆ—çš„å¯¹åº”æŒ‡å®šç¯å¢ƒçš„åˆ†æ”¯åç§°å’Œå‘å¸ƒåŠ¨ä½œï¼Œè¿™æ—¶å€™å°±ä¸ä»…éœ€è¦ç›‘å¬æ“ä½œï¼ŒåŒæ—¶ä¹Ÿè¦ç›‘å¬å¯¹åº”çš„åˆ†æ”¯åç§°,æ¥å®ç°å®šåˆ¶åŒ–çš„éƒ¨ç½²é…ç½®ï¼›

    ```
    #  ç¤ºä¾‹ï¼šä½¿ç”¨å…·æœ‰æ´»åŠ¨ç±»å‹æˆ–é…ç½®çš„å¤šä¸ªäº‹ä»¶ï¼Œç›‘å¬mainåˆ†æ”¯ä¸Šçš„pushäº‹ä»¶
   on: 
    push: 
      branches: 
        - main
    ```

##### `job`

`ä»»åŠ¡`ï¼Œä»»åŠ¡æ˜¯å·¥ä½œæµçš„ä¸»ä½“ï¼Œä¸€ä¸ªå·¥ä½œæµç”±ä¸€ä¸ªä»»åŠ¡ï¼ˆjobï¼‰æˆ–è€…å¤šä¸ªä»»åŠ¡ï¼ˆjobsï¼‰æ„æˆï¼Œè¡¨ç¤ºä¸€æ¬¡æŒç»­é›†æˆçš„è¿è¡Œ

###### job_id

   >æ¯ä¸ªä»»åŠ¡éƒ½å¿…é¡»è¦æœ‰ä¸ªidï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²

######  runs-on

  ä»»åŠ¡è¿è¡Œçš„è™šæ‹Ÿç¯å¢ƒï¼Œå¿…é¡»è¦æŒ‡å®šï¼Œä¸ç„¶æ— æ³•å·¥ä½œ

    ```
    # ç›®å‰å¯ç”¨çš„ç¯å¢ƒ
    Windows Server 2019     windows-latest æˆ– windows-2019
    Ubuntu 20.04            ubuntu-20.04
    Ubuntu 18.04            ubuntu-latest æˆ– ubuntu-18.04
    Ubuntu 16.04            ubuntu-16.04
    macOS Catalina 10.15    macos-latest æˆ– macos-10.15
    
    # ä½¿ç”¨
    runs-on: ubuntu-latest
    ```

##### `steps`

`æ­¥éª¤`ï¼Œæ¯ä¸ªä»»åŠ¡ç”±å¤šä¸ªstepæ„æˆï¼Œé€šè¿‡ä¸€ä¸ªå¤šæˆ–è€…å¤šä¸ªæ­¥éª¤å®Œæˆä¸€ä¸ªä»»åŠ¡ã€‚å¯ä»¥åœ¨è¿è¡Œå‘½ä»¤ã€è¿è¡Œä»»åŠ¡ã€è¿è¡Œä»“åº“ä¸­çš„æ“ä½œã€dockeræ³¨å†Œè¡¨ä¸­å‘å¸ƒæ“ä½œã€‚

æ³¨æ„ç‚¹ï¼š ä¸æ˜¯æ‰€æœ‰çš„stepéƒ½ä¼šè¿è¡Œæ“ä½œï¼Œä½†æ˜¯æ‰€æœ‰çš„æ“ä½œéƒ½ä¼šä½œä¸ºstepè¿è¡Œï¼Œæ¯ä¸ªstepåœ¨è™šæ‹Ÿç¯å¢ƒä¸­éƒ½ä¼šæœ‰ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œå¯ä»¥è®¿é—®å·¥ä½œåŒºå’Œæ–‡ä»¶ç³»ç»Ÿã€‚

###### name

   >æ­¥éª¤åç§°

###### run

  >è¯¥æ­¥éª¤è¿è¡Œçš„å‘½ä»¤æˆ–è€… action

###### env

  >è¯¥æ­¥éª¤æ‰€éœ€çš„ç¯å¢ƒå˜é‡

###### uses

   >é€‰æ‹©ä»»åŠ¡æ­¥éª¤ä¸­ä¸€éƒ¨åˆ†è¿è¡Œçš„æ“ä½œã€‚å…¶å®å°±æ˜¯æ­¥éª¤ä½¿ç”¨çš„`actions`,å¯ä»¥æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª
## é¡¹ç›®å®æˆ˜
æˆ‘ä»¬ä»¥**å®æˆ˜é¡¹ç›®**æ¡ˆä¾‹ä¸ºä¾‹ï¼š

* å¦‚æœÂ `.github/workflows`Â ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·åœ¨ GitHub çš„ä»“åº“ä¸­åˆ›å»ºæ­¤ç›®å½•ã€‚

* åœ¨Â `.github/workflow`Â ç›®å½•ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªåä¸ºÂ `build.yml`Â çš„æ–‡ä»¶ã€‚ æ›´å¤šä¿¡æ¯è¯·å‚é˜…â€œ[åˆ›å»ºæ–°æ–‡ä»¶](https://docs.github.com/cn/github/managing-files-in-a-repository/creating-new-files)â€ã€‚

1.  å°†ä»¥ä¸‹ YAML å†…å®¹å¤åˆ¶åˆ°Â `build.yml`Â æ–‡ä»¶ä¸­ï¼š
```yml
name: build
on: 
  push: 
    branches: 
      - main
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2 # If you're using actions/checkout@v2 you must set persist-credentials to false in most cases for the deployment to work correctly.
        with:
          persist-credentials: false

      - name: Install and Build ğŸ”§ # This example project is built using npm and outputs the result to the 'build' folder. Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
        run: |
          lerna bootstrap  # å®‰è£…ä¾èµ–
          lerna run build  # æ‰§è¡Œæ‰“åŒ…
      - name: Deploy ğŸš€
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest # å› ä¸ºæ„å»ºä¹‹åï¼Œéœ€è¦æŠŠä»£ç ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Šï¼Œæ‰€ä»¥éœ€è¦è¿æ¥åˆ°sshï¼Œå¹¶ä¸”åšä¸€ä¸ªå®‰å…¨æ‹·è´(security copy)æ“ä½œ
        env:
          WELCOME: "ssh scp ssh pipelines"
          LASTSSH: "Doing something after copying"
        with:
         host: ${{ secrets.DR_HOST }}
         user: ${{ secrets.DR_USER }}
         pass: ${{ secrets.DR_PASS }}
         port: ${{ secrets.DR_PORT }}
         connect_timeout: 10s
         first_ssh: |
            rm -rf /usr/local/webserver/nginx/html/dist
            mkdir -p /usr/local/webserver/nginx/html/dist
         scp: |
           './packages/demoPro/dist/*' => /usr/local/webserver/nginx/html/dist
           
```
ç”±äºæˆ‘ä»¬çš„é¡¹ç›®ä½¿ç”¨monorepo åŸºäºlernaçš„å¤šåŒ…ç®¡ç†é¡¹ç›®ï¼š
### `ç‰¹åˆ«æ³¨æ„`
> scp å®‰å…¨copy çš„`dist`æ–‡ä»¶æ˜¯ç›¸å¯¹äº`é¡¹ç›®æ ¹ç›®å½•`çš„è·¯å¾„ï¼›'./packages/demoPro/dist/*'
### **Install and Build ğŸ”§** 
å®‰è£…ä¾èµ–å’Œæ‰“åŒ…è¿™ç§ä½¿ç”¨æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š
   ```
    lerna bootstrap  # å®‰è£…ä¾èµ–  npm install
    lerna run build  # æ‰§è¡Œæ‰“åŒ…  npm run build
   ```

### **Deploy ğŸš€**
å°†æ‰“åŒ…åçš„`dist`æ–‡ä»¶éƒ¨ç½²åˆ°æˆ‘ä»¬æŒ‡å®šçš„`è¿œç¨‹æœåŠ¡å™¨è·¯å¾„`ï¼Œæˆ‘ä»¬éœ€è¦`ssh`è¿æ¥æœåŠ¡å™¨ï¼Œå¹¶é€šè¿‡`scp`å°†æ‰“åŒ…åçš„æ–‡ä»¶å®‰å…¨copyåˆ°æœåŠ¡å™¨è·¯å¾„ï¼š

æˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„æ˜¯å¦‚ä¸‹actionï¼Œæ‚¨ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦åœ¨marketplaceé€‰æ‹©è‡ªå·±éœ€è¦çš„actionï¼š

[action å®˜æ–¹ä¼ é€é—¨](https://github.com/marketplace/actions/ssh-scp-ssh-pipelines)
```
cross-the-world/ssh-scp-ssh-pipelines@latest

```
#### å˜é‡å®šä¹‰ä»¥åŠå‘½å
ä¸ºäº†ä¿æŠ¤éšç§ï¼Œå°±éœ€è¦å€ŸåŠ©GitHubçš„Secrets,ä»¥å˜é‡çš„æ–¹å¼è®¿é—®build.ymlæ–‡ä»¶å†…å®¹ï¼›
å¦‚ä¸‹æ‰€ç¤ºï¼š
![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ae1a123192314df5a8f0a3cde227f16d~tplv-k3u1fbpfcp-watermark.image?)
å˜é‡å«ä¹‰ä»¥åŠå®šä¹‰éœ€è¦æ ¹æ®æˆ‘ä»¬é€‰å®šçš„actionæ–‡æ¡£å‘½åå³å¯ï¼š
[action å®˜æ–¹ä¼ é€é—¨](https://github.com/marketplace/actions/ssh-scp-ssh-pipelines)

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54600c0a54284efab6ee83d09adfffec~tplv-k3u1fbpfcp-watermark.image?)
## Done

å¦‚ä¸Šå®Œæˆäº†ä¸€ä¸ªç›¸å¯¹ç®€å•çš„åŸºäºgithub actionsçš„CI/CD;æˆ‘ä»¬å¯ä»¥é€šè¿‡è§¦å‘mainåˆ†æ”¯çš„pushäº‹ä»¶ï¼Œæ¥æµ‹è¯•æ‰“åŒ…ä»¥åçš„æ–‡ä»¶æ˜¯å¦éƒ¨ç½²åˆ°æœåŠ¡å™¨æŒ‡å®šç›®å½•ï¼›

ç™»å½•æœåŠ¡å™¨æ‰§è¡ŒæŸ¥çœ‹å‘½ä»¤
```
cd  /usr/local/webserver/nginx/html/
```
